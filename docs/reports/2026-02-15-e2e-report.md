# rawctl 完整 E2E 測試與可日常使用評估報告（更新：2026-02-16）

## 0. 結論摘要（給決策者）
- **可日常使用結論**：`條件式可用`（核心流程已可跑通，阻塞級閃退已修復並驗證；但性能穩定度仍需再收斂）。
- **本輪最大成果**：`View > Single View` 觸發的閃退已定位與修復，修復後 `rawctl-e2e` 全套測試通過。
- **目前狀態**：
  - UI/整合測試：PASS
  - Unit/服務層測試：PASS
  - 崩潰：本輪修復後未再產生新的 `rawctl` crash report

---

## 1. 測試目標與範圍
本輪目標對應三個面向：
- 性能（Performance）
- UI 入口準確性（menu/入口存在且能驅動狀態）
- 交互系統運作準確度（核心互動與資料流程正確）

測試覆蓋包含：
- `RawctlSmokeTests`（含 `testSmoke_LaunchWithFolderAndSwitchViews`、`testPerf_scanFolderSignpost`）
- `rawctlUITests`（範例/啟動性能/LaunchTests）
- `rawctlTests`（資料模型、服務層、sidecar、catalog 等）
- 新增回歸測試：`HistogramDataTests/computeHandlesDeviceWhiteBitmap`

---

## 2. 關鍵問題與根因（已修復）

### 2.1 問題描述
`View > Single View` 在測試中呈現「點擊後失效/疑似閃退」。

### 2.2 根因定位
Crash log 明確指向 histogram 色域處理錯誤，不是單純 UI automation 噪音：
- crash 檔：`/Users/chuisiufai/Library/Logs/DiagnosticReports/rawctl-2026-02-16-023649.ips`
- 例外關鍵字：`NSColorRaiseWithColorSpaceError`、`redComponent`
- 呼叫鏈：`SingleView.loadPreview()` -> `HistogramData.compute(from:)` -> `HistogramView.swift:188`

### 2.3 修復內容
修正檔案：`/Users/chuisiufai/Projects/rawctl/rawctl/Components/HistogramView.swift`
- 在讀取 `NSColor` 分量前先做安全色域轉換：`extendedSRGB`/`sRGB`/`deviceRGB`
- 補上灰階色域 fallback：`genericGray`/`deviceGray`
- 對分量值做 `0...1` clamp，避免異常值

新增回歸測試：`/Users/chuisiufai/Projects/rawctl/rawctlTests/HistogramDataTests.swift`
- 驗證 `deviceWhite` 灰階 bitmap 計算 histogram 不崩潰

---

## 3. 測試執行與結果

### 3.1 針對閃退修復後 smoke 驗證
- 指令產物：
  - log：`/tmp/rawctl-test-results/rawctl-smoke-post-histfix-2026-02-16_024505.log`
  - xcresult：`/tmp/rawctl-test-results/rawctl-smoke-post-histfix-2026-02-16_024505.xcresult`
- 結果：PASS
- 核心證據：
  - `Single View (E2E)` 點擊後 `e2e.view.mode == single`
  - `singleView` 元件存在
  - 再切回 `Grid View (E2E)` 後 `e2e.view.mode == grid`

### 3.2 完整 e2e 套件
- 指令產物：
  - log：`/tmp/rawctl-test-results/rawctl-e2e-post-histfix-2026-02-16_024603.log`
  - xcresult：`/tmp/rawctl-test-results/rawctl-e2e-post-histfix-2026-02-16_024603.xcresult`
- 結果：`** TEST SUCCEEDED **`
- UI 測試摘要：`Executed 6 tests, with 0 failures`
- rawctlTests 套件摘要：所有列出的測試案例均 PASS（含 Sidecar/Catalog/CameraProfile/SmartCollection/AppState/Project）

### 3.3 回歸測試（新加）
- 指令產物：
  - log：`/tmp/rawctl-test-results/rawctl-unit-post-histfix-2026-02-16_024844.log`
  - xcresult：`/tmp/rawctl-test-results/rawctl-unit-post-histfix-2026-02-16_024844.xcresult`
- 結果：PASS
- 關鍵案例：`HistogramDataTests/computeHandlesDeviceWhiteBitmap()` PASS

---

## 4. 性能評估（Performance）

### 4.1 scanFolder signpost
來源：`/tmp/rawctl-test-results/rawctl-e2e-post-histfix-2026-02-16_024603.log`
- metric：`Duration (scanFolder)`
- average：`0.019s`
- RSD：`17.798%`
- values：`[0.015726, 0.022374, 0.024009, 0.015725, 0.018173]`

判讀：
- 絕對時間仍短，但波動（RSD）偏高，表示在不同輪次下仍有不穩定因素（測試機台負載、I/O、系統干擾等）。

### 4.2 Application Launch
來源：`/tmp/rawctl-test-results/rawctl-e2e-post-histfix-2026-02-16_024603.log`
- metric：`Duration (ApplicationLaunch)`
- average：`1.324s`
- RSD：`8.847%`
- values：`[1.354286, 1.194128, 1.200732, 1.359870, 1.509207]`

判讀：
- 啟動時間在可接受範圍，穩定度（RSD < 10%）比 scanFolder 好。

---

## 5. UI 入口準確性評估

評估結果：`PASS`

已驗證入口：
- `View` menu 存在
- `Grid View (E2E)` menu item 存在且可切回 grid
- `Single View (E2E)` menu item 存在且可切到 single

已驗證行為：
- 點擊入口後，`e2e.view.mode` 會同步變更
- UI 狀態與資料狀態一致（single/grid 對應元素出現）

---

## 6. 交互系統運作準確度評估

評估結果：`PASS（核心路徑）`

本輪已驗證交互：
- 啟動後自動載入測試素材夾，資產數與選取狀態正確
- Grid -> Single -> Grid 來回切換正確
- singleView 實際可見，非僅狀態變數改動

服務層/資料層保證（rawctlTests）：
- Sidecar 保存（含 debounce 與 AI edits 保存）
- Catalog/Project/SmartCollection/AppState 相關行為
- 新增 histogram 灰階色域回歸測試

---

## 7. 穩定性觀察

- 修復前最後一次 crash：`/Users/chuisiufai/Library/Logs/DiagnosticReports/rawctl-2026-02-16-023649.ips`
- 修復後再次執行 smoke + full e2e，未出現更新時間更晚的 `rawctl-*.ips`
- 代表本輪阻塞級崩潰已被實際迴歸消除

---

## 8. 升級到「日常使用」的建議（優先級）

### P0（本週）
- 將 `HistogramDataTests` 納入 CI 必跑，防止色域回歸。
- 保留目前 smoke 流程作為 release gate（至少跑 `testSmoke_LaunchWithFolderAndSwitchViews`）。

### P1（1-2 週）
- 為 scanFolder 建立穩定基線與閾值（建議先把 RSD 壓到 < 12%）。
- 在固定測試負載下跑 20~30 輪性能基準，分離環境噪音與真實回歸。

### P2（持續）
- 擴充 UI e2e 到匯出、批次操作、重啟恢復、sidecar 讀回一致性。
- 對性能指標做趨勢追蹤（每次 build 寫入同一報表）。

---

## 9. 最終判定
- 本輪前的阻塞問題不是單純「自動化 click 假失敗」，而是**真實程式崩潰**。
- 崩潰已修復，且修復後已用 smoke + full e2e + 回歸單測驗證通過。
- `rawctl` 目前已達到「可進入日常使用試運行」狀態；下一階段重點應轉為**性能穩定度收斂與流程覆蓋擴充**。
